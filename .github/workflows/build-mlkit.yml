name: Build MLKit XCFrameworks

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'MLKit version to build (e.g., 5.0.0)'
        required: true
        type: string
      create_release:
        description: 'Create GitHub release after build'
        required: true
        type: boolean
        default: true

jobs:
  build:
    runs-on: macos-15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.4.7'
          bundler-cache: true

      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Install CocoaPods dependencies
        run: bundle install

      - name: Update version in Podfile
        run: ruby scripts/update_version.rb ${{ inputs.version }}

      - name: Build XCFramework maker
        run: make bootstrap-builder

      - name: Install CocoaPods
        run: make bootstrap-cocoapods

      - name: Build XCFrameworks
        run: make create-xcframework

      - name: Archive XCFrameworks
        run: make archive

      - name: Calculate checksums and update Package.swift
        run: ruby scripts/update_checksums.rb ${{ inputs.version }}

      - name: Verify Package.swift
        run: swift package dump-package

      - name: Create commit
        if: inputs.create_release
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Podfile Podfile.lock Package.swift Resources/
          git commit -m "Update to MLKit ${{ inputs.version }}

          - Updated Podfile to version ${{ inputs.version }}
          - Rebuilt XCFrameworks
          - Updated checksums in Package.swift
          - Updated Info.plist files

          ðŸ¤– Generated with GitHub Actions"

      - name: Create or update tag
        if: inputs.create_release
        run: |
          # Delete existing tag if it exists (for release updates)
          if git tag -l | grep -q "^${{ inputs.version }}$"; then
            git tag -d ${{ inputs.version }}
            git push origin :refs/tags/${{ inputs.version }} || true
          fi
          git tag ${{ inputs.version }}

      - name: Push changes and tag
        if: inputs.create_release
        run: |
          git push origin main
          git push origin ${{ inputs.version }} --force
      - name: Check if release exists
        if: inputs.create_release
        id: check_release
        run: |
          if gh release view ${{ inputs.version }} &> /dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Release ${{ inputs.version }} already exists"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Release ${{ inputs.version }} does not exist"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Delete old release assets
        if: inputs.create_release && steps.check_release.outputs.exists == 'true'
        run: |
          echo "Deleting old assets from existing release..."
          for asset in GoogleToolboxForMac.xcframework.zip MLImage.xcframework.zip MLKitBarcodeScanning.xcframework.zip MLKitCommon.xcframework.zip MLKitFaceDetection.xcframework.zip MLKitVision.xcframework.zip; do
            if gh release view ${{ inputs.version }} --json assets --jq ".assets[].name" | grep -q "^${asset}$"; then
              echo "  Deleting: $asset"
              gh release delete-asset ${{ inputs.version }} "$asset" --yes || true
            fi
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create GitHub Release
        if: inputs.create_release && steps.check_release.outputs.exists == 'false'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.version }}
          name: Release ${{ inputs.version }}
          body: |
            # MLKit SwiftPM ${{ inputs.version }}

            This release updates the MLKit frameworks to version ${{ inputs.version }}.

            ## Installation

            Add to your `Package.swift`:

            ```swift
            .package(url: "https://github.com/d-date/google-mlkit-swiftpm", from: "${{ inputs.version }}")
            ```

            ## What's Changed

            - Updated to GoogleMLKit ${{ inputs.version }}
            - Rebuilt all XCFrameworks
            - Updated checksums

            ## Available Libraries

            - MLKitBarcodeScanning
            - MLKitFaceDetection

            ðŸ¤– This release was automatically generated
          draft: false
          prerelease: false
          files: |
            GoogleMLKit/*.xcframework.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload assets to existing release
        if: inputs.create_release && steps.check_release.outputs.exists == 'true'
        run: |
          echo "Uploading new assets to existing release..."
          gh release upload ${{ inputs.version }} GoogleMLKit/*.xcframework.zip --clobber
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload XCFramework artifacts
        if: ${{ !inputs.create_release }}
        uses: actions/upload-artifact@v5
        with:
          name: xcframeworks-${{ inputs.version }}
          path: GoogleMLKit/*.xcframework.zip
          retention-days: 30

      - name: Comment on related issue
        if: inputs.create_release
        uses: actions/github-script@v8
        with:
          script: |
            const version = '${{ inputs.version }}';

            // Find the issue for this version
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: ['mlkit-update']
            });

            const issue = issues.data.find(i => i.title.includes(version));

            if (issue) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `âœ… Successfully built and released version ${version}!\n\nRelease: https://github.com/${{ github.repository }}/releases/tag/${version}`
              });

              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: 'closed'
              });
            }
