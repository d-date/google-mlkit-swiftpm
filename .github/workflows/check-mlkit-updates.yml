name: Check MLKit Updates

on:
  schedule:
    # Run daily at 9:00 UTC
    - cron: '0 9 * * *'
  workflow_dispatch:
    # Allow manual trigger

# Prevent concurrent runs to avoid race condition when creating issues
concurrency:
  group: check-mlkit-updates
  cancel-in-progress: false

jobs:
  check-updates:
    runs-on: macos-latest
    outputs:
      update_available: ${{ steps.check.outputs.update_available }}
      new_version: ${{ steps.check.outputs.new_version }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.4.8'
          bundler-cache: true

      - name: Check for MLKit updates
        id: check
        run: |
          cd ${{ github.workspace }}
          output=$(ruby scripts/check_mlkit_version.rb)
          echo "$output"

          # Extract values from output
          if echo "$output" | grep -q "UPDATE_AVAILABLE=true"; then
            new_version=$(echo "$output" | grep "NEW_VERSION=" | cut -d'=' -f2)
            echo "update_available=true" >> $GITHUB_OUTPUT
            echo "new_version=$new_version" >> $GITHUB_OUTPUT
          else
            echo "update_available=false" >> $GITHUB_OUTPUT
          fi

      - name: Create issue if update available
        if: steps.check.outputs.update_available == 'true'
        uses: actions/github-script@v8
        with:
          script: |
            const newVersion = '${{ steps.check.outputs.new_version }}';
            const title = `New MLKit version available: ${newVersion}`;
            const body = `A new version of GoogleMLKit is available: **${newVersion}**

            To update:
            1. Run the automated build workflow, or
            2. Manually run: \`./scripts/build_all.sh ${newVersion}\`

            This issue was automatically created by the check-mlkit-updates workflow.`;

            // Check if issue already exists by querying for issues with mlkit-update label
            // This is more robust than just checking by title
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'mlkit-update'
            });

            console.log(`Found ${issues.data.length} open mlkit-update issue(s)`);

            // Check if an issue with this exact title already exists
            const existingIssue = issues.data.find(issue => issue.title === title);

            if (existingIssue) {
              console.log(`Issue already exists for version ${newVersion}: #${existingIssue.number}`);
            } else {
              const newIssue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['mlkit-update', 'automation']
              });
              console.log(`Created new issue #${newIssue.data.number} for MLKit version ${newVersion}`);
            }
